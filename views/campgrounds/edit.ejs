<% layout('layouts/boilerplate') %>

<div class="row">
  <h1 class="text-center">Edit campground</h1>

  <div class="col-md-6 offset-md-3">
    <form
      action="/campgrounds/<%= campground._id %>?_method=PUT"
      method="post"
      novalidate
      class="validated-form"
      enctype="multipart/form-data"
    >
      <div class="mb-3">
        <label for="title" class="form-label">Title</label>
        <input
          type="text"
          class="form-control"
          id="title"
          name="campground[title]"
          value="<%=campground.title%>"
          required
        />
        <div class="invalid-feedback">Please select a valid title.</div>
      </div>

      <div class="mb-3">
        <label for="location" class="form-label">Location</label>
        <input
          type="text"
          class="form-control"
          id="location"
          name="campground[location]"
          value="<%= campground.location %>"
          placeholder="Search for a place"
          required
        />
        <input
          type="hidden"
          id="locationValid"
          name="locationValid"
          value="false"
        />
      </div>
      <div class="mb-3">
        <label for="image" class="form-label">Add more images</label>
        <input
          class="form-control"
          type="file"
          id="image"
          name="image"
          accept="image/*"
          multiple
        />
      </div>

      <div class="mb-3">
        <label class="form-label" for="price">Campground Price</label>
        <div class="input-group">
          <span class="input-group-text" id="price-label">$</span>
          <input
            type="number"
            id="price"
            class="form-control"
            name="campground[price]"
            placeholder="0.00"
            aria-label="price"
            aria-describedby="price-label"
            value="<%= campground.price %>"
            required
          />
          <div class="invalid-feedback">Please select a valid price.</div>
        </div>
      </div>

      <div class="mb-3">
        <label for="description" class="form-label">Description</label>
        <textarea
          type="text"
          class="form-control"
          id="description"
          name="campground[description]"
          required
        >
<%= campground.description %></textarea
        >
        <div class="invalid-feedback">Please select a valid description.</div>
      </div>
      <div class="mb-3">
        <% if (campground.images && campground.images.length> 0) { %> <%
        campground.images.forEach((img,i)=> {%>
        <div class="delete-image-wrapper">
          <img src="<%= img.thumbnail %>" class="img-thumbnail" alt="" />
          <button
            type="button"
            class="btn btn-sm btn-danger delete-btn"
            data-filename="<%= img.filename %>"
            data-bs-toggle="modal"
            data-bs-target="#confirmDeleteModal"
          >
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>

        <% }) %>
        <div id="deleteInputs"></div>
        <% } else { %>
        <p class="text-muted">No images uploaded</p>
        <% } %>
      </div>
      <div class="mb-3">
        <button type="submit" class="btn btn-info">Update Campground</button>
      </div>
    </form>
    <!-- <a href="/campgrounds/<%= campground._id %>">Cancel</a> -->
  </div>
  <!-- Delete Confirmation Modal -->
  <div
    class="modal fade"
    id="confirmDeleteModal"
    tabindex="-1"
    aria-labelledby="confirmDeleteModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="confirmDeleteModalLabel">
            Confirm Delete
          </h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this image?
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
            Delete
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  const maptilerApiKey = "<%- process.env.MAPTILER_API_KEY %>";
  const price = document.getElementById("price");
  price.addEventListener("keydown", (e) => {
    if (["e", "E", "+", "-"].includes(e.key)) e.preventDefault();
  });
</script>

<script>
  const locationInput = document.getElementById("location");
  const locationValidInput = document.getElementById("locationValid");
  const originalLocation = locationInput.value;

  // mark the original location as valid initially
  if (locationInput.value === originalLocation) {
    locationValidInput.value = "true";
  }

  locationInput.addEventListener("input", () => {
    if (locationInput.value !== originalLocation) {
      locationValidInput.value = "false"; // must pick from autocomplete
    } else {
      locationValidInput.value = "true"; // unchanged → still valid
    }
  });
</script>

<script>
  let fileToDelete = null;

  document.querySelectorAll(".delete-btn").forEach((btn) => {
    btn.addEventListener("click", function () {
      fileToDelete = this.dataset.filename;
    });
  });

  document
    .getElementById("confirmDeleteBtn")
    .addEventListener("click", function () {
      if (fileToDelete) {
        const deleteInputs = document.getElementById("deleteInputs");
        const input = document.createElement("input");
        input.type = "hidden";
        input.name = "deleteImages[]";
        input.value = fileToDelete;
        deleteInputs.appendChild(input);

        document.querySelector(
          `[data-filename='${fileToDelete}']`
        ).parentElement.style.display = "none";

        const modalEl = document.getElementById("confirmDeleteModal");
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal.hide();

        fileToDelete = null; // reset ✅
      }
    });
</script>

<script src="/javascripts/autocomplete.js"></script>
